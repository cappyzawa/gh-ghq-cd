#!/bin/bash
set -e

use_tmux=false
while [[ $# -gt 0 ]]; do
  case "$1" in
  --tmux)
    use_tmux=true
    shift
    ;;
  *)
    echo "Unknown argument: $1"
    exit 1
    ;;
  esac
done

function exist_command() {
  local c=$1
  if ! type -p ${c} >/dev/null; then
    return 1
  fi
  return 0
}

function check() {
  local required_command=(fzf ghq)
  for c in ${required_command[@]}; do
    if ! exist_command "${c}"; then
      echo "${c} not found on the system" >&2
      exit 1
    fi
  done
  if ${use_tmux} && ! exist_command "tmux"; then
    echo "tmux not found on the system" >&2
    exit 1
  fi
}

function choose() {
  local cc="cat"
  if exist_command "bat"; then
    cc="bat"
  fi
  ghq list --full-path | fzf --reverse --preview "${cc} {1}/README.md"
}

function tmux_new_window() {
  local dir=$1
  repo=$(basename "${dir}")
  tmux new-window -n "${repo}" -c "${dir}"
}

check
selected="$(choose)"
[ -n "${selected}" ] || exit 1
$use_tmux && tmux_new_window "${selected}" && exit 0
\cd ${selected}
$SHELL
